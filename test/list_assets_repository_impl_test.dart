import 'package:flutter_test/flutter_test.dart';
import 'package:list_assets/core/data/assets.dart';
import 'package:list_assets/feature/list_assets_screen/data/list_assets_repository_impl.dart';
import 'package:mocktail/mocktail.dart';
import 'mocks.dart';

void main() {
  late MockCryptoApi api;
  late ListAssetsRepositoryImpl repo;

  setUp(() {
    api = MockCryptoApi();
    repo = ListAssetsRepositoryImpl(api);
  });

  test('getAssets delegates to CryptoApi', () async {
    final fakeAssets = Assets(
      timestamp: 123456789,
      data: [
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
        Datum(
          id: 'bitcoin',
          rank: '1',
          symbol: 'BTC',
          name: 'Bitcoin',
          priceUsd: '30000',
          supply: '19000000',
          maxSupply: '21000000',
          marketCapUsd: '570000000000',
          volumeUsd24Hr: '10000000000',
          changePercent24Hr: '1.2',
          vwap24Hr: '29900',
          explorer: 'https://blockchain.info',
          tokens: null,
        ),
      ],
    );

    // 1. Стабим вызов
    when(() => api.getAssets(
      apiKey: any(named: 'apiKey'),
      limit: 15,
      offset: 0,
    ))
        .thenAnswer((_) async => fakeAssets);

    final result = await repo.getAssets(limit: 15);
    expect(result.data.length, 15);
    verify(() => api.getAssets(apiKey: any(named: 'apiKey'), limit: 15, offset: 0))
        .called(1);
  });
}